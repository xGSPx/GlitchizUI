--[[
    GlitchizUI v6.0 (Fluent API Refactor)
    - NEW: The API has been refactored for ease of use. Window:AddTab() now returns a Tab object.
    - NEW: All element functions (AddButton, AddSlider, etc.) are now methods of the Tab object.
    - This provides a simpler, clearer, and less error-prone way to build UIs, similar to Rayfield.
    - The core functionality and all previous bug fixes remain intact.
--]]

local Library = {}
Library.__index = Library

-- // Theme Configuration
local Theme = {
    Background = Color3.fromRGB(20, 18, 28),      
    Header = Color3.fromRGB(45, 35, 65),          
    Accent = Color3.fromRGB(110, 70, 220),        
    Accent2 = Color3.fromRGB(0, 240, 255),        
    Text = Color3.fromRGB(255, 255, 255),         
    Font = Enum.Font.SourceSans,
    BoldFont = Enum.Font.SourceSansBold,
    TextSize = 14,
}

-- // Main Window Constructor
function Library.new(properties)
    local self = setmetatable({}, Library)

    local UserInputService = game:GetService("UserInputService")
    local TweenService = game:GetService("TweenService")
    local CoreGui = game:GetService("CoreGui")
    local RunService = game:GetService("RunService")

    local function Create(instanceType, props) local i=Instance.new(instanceType); for p,v in pairs(props or{})do i[p]=v end; return i end
    local function Animate(instance, newProps, duration) local ti=TweenInfo.new(duration or 0.15,Enum.EasingStyle.Quad,Enum.EasingDirection.Out); local t=TweenService:Create(instance,ti,newProps); t:Play(); return t end
    local function MakeDraggable(object, handle)
        local isDragging=false; local dS,oSP
        handle.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then isDragging=true;dS=i.Position;oSP=object.Position; local c;c=i.Changed:Connect(function()if i.UserInputState==Enum.UserInputState.End then isDragging=false;c:Disconnect()end end)end end)
        UserInputService.InputChanged:Connect(function(i) if isDragging and(i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch)then local d=i.Position-dS;object.Position=UDim2.new(oSP.X.Scale,oSP.X.Offset+d.X,oSP.Y.Scale,oSP.Y.Offset+d.Y)end end)
    end
    local function ApplyGlitchEffect(textLabel, isStatic)
        local cG=textLabel:Clone();cG.Name="CyanGhost";cG.TextColor3=Color3.fromRGB(0,255,255);cG.TextTransparency=0.7;cG.ZIndex=textLabel.ZIndex-1;cG.Parent=textLabel
        local rG=textLabel:Clone();rG.Name="RedGhost";rG.TextColor3=Color3.fromRGB(255,0,100);rG.TextTransparency=0.7;rG.ZIndex=textLabel.ZIndex-1;rG.Parent=textLabel
        if isStatic then cG.Position=UDim2.fromOffset(-2,0);rG.Position=UDim2.fromOffset(2,0)
        else
            local isH=false;local hC
            textLabel.MouseEnter:Connect(function()if isH then return end;isH=true;hC=RunService.Heartbeat:Connect(function()cG.Position=UDim2.fromOffset(math.random(-3,3),math.random(-2,2));rG.Position=UDim2.fromOffset(math.random(-3,3),math.random(-2,2))end)end)
            textLabel.MouseLeave:Connect(function()if not isH then return end;isH=false;if hC then hC:Disconnect();hC=nil end;Animate(cG,{Position=UDim2.fromOffset(0,0)},0.1);Animate(rG,{Position=UDim2.fromOffset(0,0)},0.1)end)
        end
    end

    self.Title = properties.Title or "GlitchizUI"; self.Tabs = {}; self.Keybind = properties.Keybind or Enum.KeyCode.RightControl; self.ActiveConnections = {}
    
    local isMobile = UserInputService.TouchEnabled and workspace.CurrentCamera.ViewportSize.X < 700
    self.Size = isMobile and UDim2.new(0.9, 0, 0.65, 0) or (properties.Size or UDim2.new(0, 550, 0, 350))

    self.ScreenGui = Create("ScreenGui", {Name="GlitchizUI_ScreenGui", ZIndexBehavior=Enum.ZIndexBehavior.Global, Parent=CoreGui})
    self.MainFrame = Create("Frame", {Name="MainFrame", Size=self.Size, Position=properties.Position or UDim2.new(0.5,-self.Size.X.Offset/2,0.5,-self.Size.Y.Offset/2), BackgroundColor3=Theme.Background, BackgroundTransparency=0.15, BorderSizePixel=0, Parent=self.ScreenGui})
    Create("UICorner",{CornerRadius=UDim.new(0,6),Parent=self.MainFrame});Create("UIStroke",{Color=Theme.Accent2,Transparency=0.7,Thickness=1.5,Parent=self.MainFrame})

    local header = Create("Frame",{Name="Header",Size=UDim2.new(1,0,0,40),BackgroundColor3=Theme.Header,BackgroundTransparency=0.2,BorderSizePixel=0,ZIndex=2,Parent=self.MainFrame})
    local dragFrame = Create("Frame",{Name="DragFrame",Size=UDim2.new(1,-60,1,0),BackgroundTransparency=1,Parent=header})
    local titleLabel = Create("TextLabel",{Name="Title",Size=UDim2.new(1,0,1,0),Position=UDim2.new(0,15,0,0),Text=self.Title,Font=Theme.BoldFont,TextSize=Theme.TextSize+4,TextColor3=Theme.Text,TextXAlignment=Enum.TextXAlignment.Left,BackgroundTransparency=1,Parent=dragFrame})
    ApplyGlitchEffect(titleLabel,true)
    
    local controls = Create("Frame",{Name="Controls",Size=UDim2.new(0,60,1,0),Position=UDim2.new(1,-60,0,0),BackgroundTransparency=1,Parent=header})
    local hideButton = Create("TextButton",{Name="HideButton",Size=UDim2.new(0,30,1,0),BackgroundColor3=Color3.new(),BackgroundTransparency=1,Text="—",Font=Theme.BoldFont,TextSize=16,TextColor3=Theme.Text,Parent=controls})
    local deleteButton = Create("TextButton",{Name="DeleteButton",Size=UDim2.new(0,30,1,0),Position=UDim2.new(0,30,0,0),BackgroundColor3=Color3.new(),BackgroundTransparency=1,Text="✕",Font=Theme.BoldFont,TextSize=16,TextColor3=Theme.Text,Parent=controls})
    
    local contentContainer = Create("Frame",{Name="ContentContainer",Size=UDim2.new(1,0,1,-40),Position=UDim2.new(0,0,0,40),BackgroundTransparency=1,ZIndex=1,Parent=self.MainFrame})
    local tabContainer
    if isMobile then
        tabContainer = Create("ScrollingFrame",{Name="TabContainer",Size=UDim2.new(1,0,0,35),BackgroundColor3=Theme.Background,BackgroundTransparency=0.3,BorderSizePixel=0,ScrollingDirection=Enum.ScrollingDirection.X,ScrollBarThickness=0,Parent=contentContainer})
        Create("UIListLayout",{FillDirection=Enum.FillDirection.Horizontal,SortOrder=Enum.SortOrder.LayoutOrder,Padding=UDim.new(0,5),VerticalAlignment=Enum.VerticalAlignment.Center,Parent=tabContainer})
        self.ContentFrame=Create("Frame",{Name="ContentFrame",Size=UDim2.new(1,0,1,-35),Position=UDim2.new(0,0,0,35),BackgroundTransparency=1,ClipsDescendants=true,Parent=contentContainer})
    else
        tabContainer = Create("ScrollingFrame",{Name="TabContainer",Size=UDim2.new(0,120,1,0),BackgroundColor3=Theme.Background,BackgroundTransparency=0.3,BorderSizePixel=0,ScrollingDirection=Enum.ScrollingDirection.Y,ScrollBarThickness=2,Parent=contentContainer})
        Create("UIListLayout",{FillDirection=Enum.FillDirection.Vertical,SortOrder=Enum.SortOrder.LayoutOrder,Padding=UDim.new(0,5),HorizontalAlignment=Enum.HorizontalAlignment.Center,Parent=tabContainer})
        self.ContentFrame=Create("Frame",{Name="ContentFrame",Size=UDim2.new(1,-120,1,0),Position=UDim2.new(0,120,0,0),BackgroundTransparency=1,ClipsDescendants=true,Parent=contentContainer})
    end

    MakeDraggable(self.MainFrame,dragFrame)
    
    function self:Destroy() if self.ScreenGui then self.ScreenGui:Destroy()end;for _,c in ipairs(self.ActiveConnections)do c:Disconnect()end;for i,v in pairs(self)do self[i]=nil;setmetatable(self,nil)end end
    local isContentVisible = true
    local function ToggleMinimize() isContentVisible=not isContentVisible;contentContainer.Visible=isContentVisible;Animate(self.MainFrame,{Size=isContentVisible and self.Size or UDim2.new(self.Size.X.Scale,self.Size.X.Offset,0,40)},0.2);hideButton.Text=isContentVisible and"—"or"+"end
    hideButton.MouseButton1Click:Connect(ToggleMinimize);deleteButton.MouseButton1Click:Connect(function()self:Destroy()end)
    local function ToggleVisibility() self.MainFrame.Visible=not self.MainFrame.Visible end
    table.insert(self.ActiveConnections,UserInputService.InputBegan:Connect(function(i,gpe)if not gpe and i.KeyCode==self.Keybind then ToggleVisibility()end end))
    
    local isTweeningTab = false
    function self:AddTab(name)
        -- // This is the core of the Fluent API change
        local TabObject = {}
        
        local buttonSize = isMobile and UDim2.new(0,100,1,-10) or UDim2.new(1,-10,0,30)
        TabObject.Button = Create("TextButton",{Name=name,Size=buttonSize,Text=name,Font=Theme.BoldFont,TextSize=Theme.TextSize,TextColor3=Theme.Text,BackgroundColor3=Theme.Header,BorderSizePixel=0,LayoutOrder=#self.Tabs+1,Parent=tabContainer});Create("UICorner",{CornerRadius=UDim.new(0,4),Parent=TabObject.Button});ApplyGlitchEffect(TabObject.Button,false)
        TabObject.Indicator = Create("Frame",{Name="Indicator",Size=isMobile and UDim2.new(0.6,0,0,3)or UDim2.new(0,3,0.6,0),Position=isMobile and UDim2.new(0.2,0,1,-3)or UDim2.new(0,0,0.2,0),BackgroundColor3=Theme.Accent2,BorderSizePixel=0,Visible=false,Parent=TabObject.Button});Create("UICorner",{Parent=TabObject.Indicator})
        TabObject.Frame = Create("ScrollingFrame",{Name=name.."_Content",Size=UDim2.new(1,0,1,0),BackgroundTransparency=1,BorderSizePixel=0,CanvasSize=UDim2.new(0,0,0,0),ScrollBarImageColor3=Theme.Accent2,ScrollBarThickness=4,Parent=self.ContentFrame,Visible=false});Create("UIListLayout",{FillDirection=Enum.FillDirection.Vertical,SortOrder=Enum.SortOrder.LayoutOrder,Padding=UDim.new(0,10),HorizontalAlignment=Enum.HorizontalAlignment.Left,Parent=TabObject.Frame});Create("UIPadding",{PaddingTop=UDim.new(0,15),PaddingLeft=UDim.new(0,15),Parent=TabObject.Frame})
        
        TabObject.Button.MouseButton1Click:Connect(function()
            if self.ActiveTab==TabObject or isTweeningTab then return end;isTweeningTab=true
            local oldTab=self.ActiveTab
            if oldTab then oldTab.Button.BackgroundColor3=Theme.Header;oldTab.Indicator.Visible=false;Animate(oldTab.Frame,{Position=UDim2.new(-1,0,0,0)},0.2)end
            TabObject.Frame.Position=UDim2.new(1,0,0,0);TabObject.Frame.Visible=true;TabObject.Button.BackgroundColor3=Theme.Accent;TabObject.Indicator.Visible=true
            Animate(TabObject.Frame,{Position=UDim2.new(0,0,0,0)},0.2).Completed:Wait();if oldTab then oldTab.Frame.Visible=false end
            self.ActiveTab=TabObject;isTweeningTab=false
        end)
        
        if not self.ActiveTab then
            TabObject.Button.BackgroundColor3=Theme.Accent;TabObject.Indicator.Visible=true;TabObject.Frame.Visible=true;TabObject.Frame.Position=UDim2.new(0,0,0,0);self.ActiveTab=TabObject
        end
        self.Tabs[name]=TabObject
        
        -- // Element functions are now methods of the returned TabObject
        function TabObject:AddElement(height, isDropdown) 
            local elFrame = Create("Frame",{Size=UDim2.new(1,-30,0,height),BackgroundTransparency=1,LayoutOrder=#TabObject.Frame:GetChildren(),ClipsDescendants=not isDropdown,Parent=TabObject.Frame})
            task.wait(); TabObject.Frame.CanvasSize = UDim2.new(0,0,0,TabObject.Frame.UIListLayout.AbsoluteContentSize.Y+30)
            return elFrame
        end
        function TabObject:AddLabel(p) local f=TabObject:AddElement(20);local l=Create("TextLabel",{Size=UDim2.new(1,0,1,0),Text=p.Text or"Label",Font=p.Bold and Theme.BoldFont or Theme.Font,TextSize=p.Big and Theme.TextSize+4 or Theme.TextSize,TextColor3=p.Color or Theme.Text,TextXAlignment=Enum.TextXAlignment.Left,BackgroundTransparency=1,Parent=f});local o={};function o:Set(t)l.Text=t end;return o end
        function TabObject:AddDivider() local f=TabObject:AddElement(8);Create("Frame",{Size=UDim2.new(1,0,0,1),Position=UDim2.new(0.5,0,0.5,0),AnchorPoint=Vector2.new(0.5,0.5),BackgroundColor3=Theme.Accent,BackgroundTransparency=0.5,BorderSizePixel=0,Parent=f})end
        function TabObject:AddButton(p) local f=TabObject:AddElement(35);local b=Create("TextButton",{Name="Button",Size=UDim2.new(1,0,1,0),Text=p.Text or"Button",Font=Theme.Font,TextSize=Theme.TextSize,TextColor3=Theme.Text,BackgroundColor3=Theme.Header,Parent=f});Create("UICorner",{CornerRadius=UDim.new(0,4),Parent=b});local s=Create("UIStroke",{Color=Theme.Accent,Parent=b});ApplyGlitchEffect(b,false);if p.Callback then b.MouseButton1Click:Connect(function()pcall(p.Callback)end)end;b.MouseEnter:Connect(function()Animate(s,{Color=Theme.Accent2})end);b.MouseLeave:Connect(function()Animate(s,{Color=Theme.Accent})end);return{}end
        function TabObject:AddToggle(p) local f=TabObject:AddElement(25);local o={Value=p.Default or false};local l=Create("TextLabel",{Size=UDim2.new(1,-35,1,0),Position=UDim2.new(0,35,0,0),Text=p.Text or"Toggle",Font=Theme.Font,TextSize=Theme.TextSize,TextColor3=Theme.Text,TextXAlignment=Enum.TextXAlignment.Left,BackgroundTransparency=1,Parent=f});local b=Create("TextButton",{Name="Toggle",Size=UDim2.new(0,25,0,25),Position=UDim2.new(0,0,0.5,0),AnchorPoint=Vector2.new(0,0.5),BackgroundColor3=Theme.Header,Text="",Parent=f});Create("UICorner",{CornerRadius=UDim.new(0,4),Parent=b});local s=Create("UIStroke",{Color=Theme.Accent,Parent=b});local m=Create("Frame",{Name="Checkmark",Size=UDim2.new(0.6,0,0.6,0),Position=UDim2.new(0.5,0,0.5,0),AnchorPoint=Vector2.new(0.5,0.5),BackgroundColor3=Theme.Accent2,Visible=o.Value,Parent=b});Create("UICorner",{CornerRadius=UDim.new(0,2),Parent=m});l.Parent=b;ApplyGlitchEffect(b,false);l.Parent=f;b.MouseButton1Click:Connect(function()o.Value=not o.Value;m.Visible=o.Value;if p.Callback then pcall(p.Callback,o.Value)end end);b.MouseEnter:Connect(function()Animate(s,{Color=Theme.Accent2})end);b.MouseLeave:Connect(function()Animate(s,{Color=Theme.Accent})end);return o end
        function TabObject:AddTextbox(p) local f=TabObject:AddElement(35);local o={};local bf=Create("Frame",{Size=UDim2.new(1,0,1,0),BackgroundColor3=Theme.Header,Parent=f});Create("UICorner",{CornerRadius=UDim.new(0,4),Parent=bf});Create("UIStroke",{Color=Theme.Accent,Parent=bf});local b=Create("TextBox",{Name="Textbox",Size=UDim2.new(1,-85,1,0),Position=UDim2.new(0,5,0,0),Text=p.Default or"",PlaceholderText=p.Placeholder or"...",Font=Theme.Font,TextSize=Theme.TextSize,TextColor3=Theme.Text,BackgroundTransparency=1,ClearTextOnFocus=p.ClearOnFocus or false,Parent=bf});local btn=Create("TextButton",{Name="Submit",Size=UDim2.new(0,70,0.8,0),Position=UDim2.new(1,-75,0.1,0),Text=p.ButtonText or"Submit",Font=Theme.Font,TextSize=Theme.TextSize-1,TextColor3=Theme.Text,BackgroundColor3=Theme.Accent,Parent=bf});Create("UICorner",{CornerRadius=UDim.new(0,4),Parent=btn});local function fc()if p.Callback then pcall(p.Callback,b.Text)end end;b.FocusLost:Connect(function(e)if e then fc()end end);btn.MouseButton1Click:Connect(fc);function o:GetText()return b.Text end;function o:SetText(t)b.Text=t end;return o end
        function TabObject:AddSlider(p) local f=TabObject:AddElement(45);local min,max,val=p.Min or 0,p.Max or 100,p.Default or 50;local l=Create("TextLabel",{Size=UDim2.new(1,0,0,20),Text=(p.Text or"Slider")..": "..math.floor(val),Font=Theme.Font,TextSize=Theme.TextSize,TextColor3=Theme.Text,TextXAlignment=Enum.TextXAlignment.Left,BackgroundTransparency=1,Parent=f});local t=Create("Frame",{Name="Track",Size=UDim2.new(1,0,0,6),Position=UDim2.new(0,0,0,25),BackgroundColor3=Theme.Header,Parent=f});Create("UICorner",{Parent=t});local pr=Create("Frame",{Name="Progress",Size=UDim2.new((val-min)/(max-min),0,1,0),BackgroundColor3=Theme.Accent2,Parent=t});Create("UICorner",{Parent=pr});local h=Create("Frame",{Name="Handle",Size=UDim2.new(0,12,0,12),Position=UDim2.new(1,0,0.5,0),AnchorPoint=Vector2.new(0.5,0.5),BackgroundColor3=Theme.Text,Parent=pr});Create("UICorner",{CornerRadius=UDim.new(1,0),Parent=h});local drag=false;local iCC,iEC;local function u(iP)local rX=iP.X-t.AbsolutePosition.X;local pct=math.clamp(rX/t.AbsoluteSize.X,0,1);val=min+(max-min)*pct;Animate(pr,{Size=UDim2.new(pct,0,1,0)},0.05);l.Text=(p.Text or"Slider")..": "..math.floor(val);if p.Callback then pcall(p.Callback,val)end end;t.InputBegan:Connect(function(i)if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then drag=true;u(i.Position);iCC=UserInputService.InputChanged:Connect(function(cI)if drag and(cI.UserInputType==Enum.UserInputType.MouseMovement or cI.UserInputType==Enum.UserInputType.Touch)then u(cI.Position)end end);table.insert(self.ActiveConnections,iCC);iEC=UserInputService.InputEnded:Connect(function(eI)if eI.UserInputType==Enum.UserInputType.MouseButton1 or eI.UserInputType==Enum.UserInputType.Touch then drag=false;if iCC then iCC:Disconnect()end;if iEC then iEC:Disconnect()end end end);table.insert(self.ActiveConnections,iEC)end end);return{}end
        function TabObject:AddDropdown(p) local f=TabObject:AddElement(35,true);local isOpen=false;local maxH=150;local optH=32;local totalH=#p.Options*optH+4;local visH=math.min(totalH,maxH);local mB=Create("TextButton",{Name="DropdownMain",Size=UDim2.new(1,0,1,0),Text="  ".. (p.Default or"Select an Option"),Font=Theme.Font,TextSize=Theme.TextSize,TextColor3=Theme.Text,BackgroundColor3=Theme.Header,TextXAlignment=Enum.TextXAlignment.Left,Parent=f});Create("UICorner",{CornerRadius=UDim.new(0,4),Parent=mB});Create("UIStroke",{Color=Theme.Accent,Parent=mB});local ar=Create("TextLabel",{Name="Arrow",Size=UDim2.new(0,30,1,0),Position=UDim2.new(1,-30,0,0),BackgroundTransparency=1,Font=Theme.BoldFont,Text="▼",TextColor3=Theme.Text,TextSize=12,Parent=mB});local oF=Create("ScrollingFrame",{Name="Options",Size=UDim2.new(1,0,0,0),Position=UDim2.new(0,0,1,5),BackgroundColor3=Theme.Background,BackgroundTransparency=0.1,BorderSizePixel=0,ClipsDescendants=true,Visible=false,CanvasSize=UDim2.new(0,0,0,totalH/28*32),ScrollBarImageColor3=Theme.Accent2,ScrollBarThickness=4,ZIndex=f.ZIndex+1,Parent=f});Create("UICorner",{CornerRadius=UDim.new(0,4),Parent=oF});Create("UIStroke",{Color=Theme.Accent,Parent=oF});local lL=Create("UIListLayout",{Padding=UDim.new(0,4),HorizontalAlignment=Enum.HorizontalAlignment.Stretch,Parent=oF});Create("UIPadding",{PaddingLeft=UDim.new(0,4),PaddingRight=UDim.new(0,4),Parent=oF});local function cD()isOpen=false;Animate(ar,{Rotation=0});Animate(f,{Size=UDim2.new(1,-30,0,35)},0.2);local an=Animate(oF,{Size=UDim2.new(1,0,0,0)},0.2);an.Completed:Connect(function()oF.Visible=false end)end;for _,oT in ipairs(p.Options or{})do local oB=Create("TextButton",{Name=oT,Size=UDim2.new(0,0,0,28),Text="  "..oT,Font=Theme.Font,TextSize=Theme.TextSize-1,TextColor3=Theme.Text,BackgroundColor3=Theme.Header,TextXAlignment=Enum.TextXAlignment.Left,AutoButtonColor=false,Parent=oF});Create("UICorner",{CornerRadius=UDim.new(0,2),Parent=oB});oB.MouseEnter:Connect(function()Animate(oB,{BackgroundColor3=Theme.Accent},0.1)end);oB.MouseLeave:Connect(function()Animate(oB,{BackgroundColor3=Theme.Header},0.1)end);oB.MouseButton1Click:Connect(function()mB.Text="  "..oT;cD();if p.Callback then pcall(p.Callback,oT)end end)end;mB.MouseButton1Click:Connect(function()isOpen=not isOpen;Animate(ar,{Rotation=isOpen and 180 or 0});if isOpen then oF.Visible=true;Animate(f,{Size=UDim2.new(1,-30,0,35+visH+5)},0.2);Animate(oF,{Size=UDim2.new(1,0,0,visH)},0.2)else cD()end end);return{}end
        
        return TabObject
    end

    return self
end

return Library
